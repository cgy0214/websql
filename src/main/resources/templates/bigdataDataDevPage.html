<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>数据开发</title>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/static/img/favicon.ico}" media="screen"/>
    <link rel="stylesheet" th:href="@{/static/css/layui.css}" media="all"/>
    <style>
        /* 自定义小尺寸导航 */
        .layui-nav-small .layui-nav-item {
            height: 35px !important;
            line-height: 35px !important;
            margin: 0 5px;
        }

        .layui-nav-small .layui-nav-item a {
            padding: 0 10px !important;
            height: 35px !important;
            line-height: 35px !important;
            font-size: 16px !important;
        }

        /* 图标样式调整 */
        .layui-nav-small .layui-icon {
            font-size: 18px !important;
        }

        </* 移除选中效果 */
        .layui-nav-small .layui-this {
            background-color: transparent !important;
        }

        .monaco-wrapper {
            width: 99%;
            height: calc(100vh - 50px);
        }
        #monaco-editor {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

    </style>
</head>
<body>
<div class="layui-card-header" style="padding:0">
        <ul class="layui-nav layui-bg-gray layui-nav-small" lay-filter="left-icons">
            <li class="layui-nav-item"><a href="javascript:;" title="保存" class="layui-icon layui-icon-play"></a></li>
            <li class="layui-nav-item"><a href="javascript:;" title="定时" class="layui-icon layui-icon-time"></a></li>
            <li class="layui-nav-item"><a href="javascript:;" title="发布" class="layui-icon layui-icon-release"></a></li>
            <li class="layui-nav-item"><a href="javascript:;" title="任务" class="layui-icon layui-icon-list"></a></li>
            <li class="layui-nav-item"><a href="javascript:;" title="模板" class="layui-icon layui-icon-template"></a></li>
            <li class="layui-nav-item"><a href="javascript:;" title="帮助" class="layui-icon layui-icon-about"></a></li>
        </ul>
</div>
<div>
    <div class="monaco-wrapper">
        <div id="monaco-editor"></div>
    </div>
</div>

<script th:src="@{/static/layui.js}"></script>
<script th:src="@{/static/lay-config.js}"></script>
<script th:replace="~{base::ctx}"></script>
<script th:src="@{/static/monaco/min/vs/loader.js}"></script>
<script>

    layui.use(['element','layer', 'form'], function () {
        const layer = layui.layer;
        const form = layui.form;
        const element = layui.element;
        const $ = layui.jquery;

        form.on('submit(save)', function (data) {
            const field = data.field;
            post(ctx + "bigdataManager/saveTask", field, (res) => {
                layer.alert(res.msg, {icon: res.code === 200 ? 1 : 2});
            })
            return false;
        });

        form.on('submit(saveAndExecute)', function (data) {
            const field = data.field;
            post(ctx + "bigdataManager/saveTask", field, (res) => {
                if (res.code === 200) {
                    layer.msg('保存成功，准备执行任务', {icon: 1});
                } else {
                    layer.alert(res(res.msg, {icon: 2}));
                }
            })
            return false;
        });

        require.config({
            paths: {
                'vs': '/static/monaco/min/vs'
            }
        });
        require(['vs/editor/editor.main'], function() {
            initEditor();
        });
        let editor = null;
        function initEditor() {
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: `-- SQL 编辑器示例
                        SELECT * FROM users
                        WHERE id = 1
                        AND status = 'active'

                        CREATE TABLE users (
                            id INT PRIMARY KEY,
                            name VARCHAR(50),
                            email VARCHAR(100)
                        );`,
                language: 'sql',
                theme: 'vs-light',
                fontSize: 14,
                automaticLayout: true,
                minimap: {
                    enabled: true,  // 启用预览
                    side: 'right',  // 预览在右侧
                    size: 'fill'    // 自适应大小
                },
                scrollbar: {
                    vertical: 'auto',
                    horizontal: 'auto'
                }
            });
        }

        $('.layui-nav-small .layui-nav-item a').on('click', function(e) {
            $('.layui-nav-small .layui-nav-item').removeClass('layui-this');

            const title = $(this).attr('title');
            switch(title) {
                case '保存':
                    saveSQL();
                    break;
                case '定时':
                    layer.msg('定时功能开发中...');
                    executeSQL();
                    break;
                case '发布':
                    layer.msg('发布功能开发中...');
                    formatSQL();
                    break;
                case '任务':
                    layer.msg('任务管理功能开发中...');
                    break;
                case '模板':
                    layer.msg('模板功能开发中...');
                    break;
            }
        });


        function executeSQL() {
            if (!editor) return;
            const sql = editor.getValue();
            layer.msg(sql);
        }

        function formatSQL() {
            if (!editor) {
                layui.layer.msg('编辑器未初始化');
                return;
            }

            // 获取当前选中的文本或整个文档
            const selection = editor.getSelection();
            const model = editor.getModel();
            const text = selection.isEmpty() ?
                model.getValue() :
                model.getValueInRange(selection);

            // 简单的格式化逻辑
            const formatted = text
                .replace(/\b(SELECT|FROM|WHERE|INSERT|UPDATE|DELETE|CREATE|TABLE|VALUES|SET)\b/gi, '\n$1')
                .replace(/,(\s*)/g, ',\n    ')
                .trim();

            editor.executeEdits('', [{
                range: selection.isEmpty() ?
                    model.getFullModelRange() :
                    selection,
                text: formatted
            }]);

            layui.layer.msg('格式化完成');
        }

        function saveSQL() {
            if (!editor) return;
            const sql = editor.getValue();
            const blob = new Blob([sql], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_${Date.now()}.sql`;
            a.click();
            URL.revokeObjectURL(url);
            layui.layer.msg('保存成功');
        }
    });

</script>
</body>
</html>
