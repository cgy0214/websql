<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>数据开发</title>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/static/img/favicon.ico}" media="screen"/>
    <link rel="stylesheet" th:href="@{/static/css/layui.css}" media="all"/>
    <style>
        /* 自定义小尺寸导航 */
        .layui-nav-small .layui-nav-item {
            height: 35px !important;
            line-height: 35px !important;
            margin: 0 5px;
        }

        .layui-nav-small .layui-nav-item a {
            padding: 0 10px !important;
            height: 35px !important;
            line-height: 35px !important;
            font-size: 16px !important;
        }

        /* 图标样式调整 */
        .layui-nav-small .layui-icon {
            font-size: 18px !important;
        }

        /* 移除选中效果 */
        .layui-nav-small .layui-this {
            background-color: transparent !important;
        }

        .monaco-wrapper {
            width: 99%;
            height: calc(100vh - 50px);
        }

        #monaco-editor {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

    </style>
</head>
<body>
<div class="layui-card-header" style="padding:0">
    <ul class="layui-nav layui-bg-gray layui-nav-small" lay-filter="left-icons">
        <li class="layui-nav-item"><a href="javascript:;" title="运行" class="layui-icon layui-icon-play"></a></li>
        <li class="layui-nav-item"><a href="javascript:;" title="保存" class="layui-icon layui-icon-file"></a></li>
        <li class="layui-nav-item"><a href="javascript:;" title="格式化" class="layui-icon layui-icon-fonts-code"></a>
        </li>
        <li class="layui-nav-item"><a href="javascript:;" title="定时" class="layui-icon layui-icon-time"></a></li>
        <li class="layui-nav-item"><a href="javascript:;" title="发布" class="layui-icon layui-icon-release"></a></li>
        <li class="layui-nav-item"><a href="javascript:;" title="任务" class="layui-icon layui-icon-list"></a></li>
        <li class="layui-nav-item"><a href="javascript:;" title="模板" class="layui-icon layui-icon-template"></a></li>
        <li class="layui-nav-item"><a href="javascript:;" title="帮助" class="layui-icon layui-icon-about"></a></li>
    </ul>
</div>
<div>
    <div class="monaco-wrapper">
        <div id="monaco-editor"></div>
    </div>
</div>


<!-- 保存 -->
<div id="save-layer-wrapper" style="display: none;">
    <div style="padding:10px;">
        <form class="layui-form" action="" id="dataDevForm">

            <div class="layui-form-item">
                <label class="layui-form-label">任务名称</label>
                <div class="layui-input-inline" style="width: 50%;">
                    <input type="text" name="taskName" id="taskName" lay-verify="required" autocomplete="off" lay-affix="clear"
                           placeholder="请输入任务名称" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">任务类型</label>
                <div class="layui-input-inline" style="width: 50%;">
                    <select name="taskType" id="taskType" lay-verify="required">
                        <option value="">请选择任务类型</option>
                        <option value="SQL">SQL任务</option>
                        <option value="ETL">ETL任务</option>
                        <option value="PYTHON">Python任务</option>
                    </select>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">任务定时</label>
                <div class="layui-input-inline" style="width: 50%;">
                    <input type="text" name="cronName" id="cronName" lay-verify="required" autocomplete="off" lay-affix="clear"
                           placeholder="请输入定时时间" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">任务编码</label>
                <div class="layui-input-inline" style="width: 50%;">
                    <input type="text" name="taskCode" id="taskCode" autocomplete="off" lay-affix="clear"
                           placeholder="请输入任务编码" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">任务描述</label>
                <div class="layui-input-block" style="width: 75%;">
                    <textarea name="description" id="description" placeholder="请输入任务描述" class="layui-textarea"></textarea>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">任务状态</label>
                <div class="layui-input-inline" style="width: 40%;">
                    <select name="status" id="status">
                        <option value="启用">启用</option>
                        <option value="停用">停用</option>
                    </select>
                </div>
            </div>

            <div class="page-footer">
                <div class="btn-list">
                    <div class="btnlist">
                        <button class="layui-btn layui-btn-primary layui-border-green layui-btn-sm" lay-submit
                                lay-filter="save">
                            <i class="layui-icon layui-icon-ok">&nbsp;</i>保存
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<script th:src="@{/static/code/sql-formatter.min.cjs}"></script>
<script th:src="@{/static/monaco/min/vs/loader.js}"></script>
<script th:src="@{/static/layui.js}"></script>
<script th:src="@{/static/lay-config.js}"></script>
<script th:replace="~{base::ctx}"></script>
<script th:src="@{/static/monaco/min/vs/loader.js}"></script>
<script>

    layui.use(['element', 'layer', 'form'], function () {
        const layer = layui.layer;
        const form = layui.form;
        const element = layui.element;
        const $ = layui.jquery;

        form.on('submit(save)', function (data) {
            const field = data.field;
            post(ctx + "bigdataManager/saveTask", field, (res) => {
                layer.alert(res.msg, {icon: res.code === 200 ? 1 : 2});
            })
            return false;
        });

        form.on('submit(saveAndExecute)', function (data) {
            const field = data.field;
            post(ctx + "bigdataManager/saveTask", field, (res) => {
                if (res.code === 200) {
                    layer.msg('保存成功，准备执行任务', {icon: 1});
                } else {
                    layer.alert(res(res.msg, {icon: 2}));
                }
            })
            return false;
        });

        require.config({
            paths: {
                'vs': '/static/monaco/min/vs'
            }
        });

        require(['vs/editor/editor.main'], function () {
            initEditor();
        });

        let editor = null;

        function initEditor() {
            editor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: `-- SQL 编辑器示例
                        SELECT * FROM users
                        WHERE id = 1
                        AND status = 'active'

                        CREATE TABLE users (
                            id INT PRIMARY KEY,
                            name VARCHAR(50),
                            email VARCHAR(100)
                        );`,
                language: 'sql',
                theme: 'vs-light',
                fontSize: 14,
                automaticLayout: true,
                minimap: {
                    enabled: true,  // 启用预览
                    side: 'right',  // 预览在右侧
                    size: 'fill'    // 自适应大小
                },
                scrollbar: {
                    vertical: 'auto',
                    horizontal: 'auto'
                }
            });
        }

        $('.layui-nav-small .layui-nav-item a').on('click', function (e) {
            $('.layui-nav-small .layui-nav-item').removeClass('layui-this');

            const title = $(this).attr('title');
            switch (title) {
                case '运行':
                    executeSQL();
                    break;
                case '保存':
                    saveData();
                    break;
                case '格式化':
                    formatSQL();
                    break;
                case '定时':
                    layer.msg('定时功能开发中...');
                    break;
                case '发布':
                    layer.msg('发布功能开发中...');
                    break;
                case '任务':
                    layer.msg('任务管理功能开发中...');
                    break;
                case '模板':
                    layer.msg('模板功能开发中...');
                    break;
                case '帮助':
                    showHelp();
                    break;
            }
        });


        function executeSQL() {
            if (!editor) return;
            const sql = editor.getValue();
            layer.msg(sql);
        }

        function formatSQL() {
            if (!editor) {
                layui.layer.msg('编辑器未初始化');
                return;
            }
            try {
                const formatted = window.sqlFormatter.format(editor.getValue(), {
                    language: 'sql',
                    indent: '    ',
                    uppercase: true,
                    linesBetweenQueries: 2
                });
                editor.setValue(formatted);
            } catch (error) {
                console.error('格式化失败:', error);
            }
        }

        function showHelp() {
            const helpConfig = helpToolbarConfig('https://gitee.com/boy_0214/websql/wikis/pages?sort_id=16922011&doc_id=3405209');
            helpConfig.onClick();
        }

        function saveSQL() {
            if (!editor) return;
            const sql = editor.getValue();
            const blob = new Blob([sql], {type: 'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_${Date.now()}.sql`;
            a.click();
            URL.revokeObjectURL(url);
            layui.layer.msg('保存成功');
        }

        /**
         * 初始化保存页面,如果已保存无需展示，否则创建任务
         */
        function viewSavePage(){

            let id = null;
            const title = id == null ? '新建开发任务' : '修改保存任务';
            layer.open({
                type: 1,
                area: ['600px', '500px'],
                title: title,
                shade: 0.6,
                shadeClose: false,
                maxmin: false,
                closeBtn:0,
                anim: 0,
                content: $('#save-layer-wrapper'),
            });
        }
        viewSavePage();
    });

</script>
</body>
</html>
