<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <title>WebSql-SQL执行</title>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/static/img/favicon.ico}" media="screen"/>
    <link rel="stylesheet" th:href="@{/static/css/layui.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/code/codemirror.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/code/show-hint.css}" media="all"/>
    <link rel="stylesheet" th:href="@{/static/code/highlight.min.css}" media="all">
    <link rel="stylesheet" th:href="@{/static/css/sqlPage.css}" media="all">
    <style>

    </style>
</head>
<body>
<div id="menu-id">
    <form class="layui-form card">
        <div class="layui-form-item button-row">

            <div class="layui-input-inline layui-select-sm">
                <select name="dbtype" id="dbtype" lay-filter="dbtype" lay-search="" lay-affix="clear"></select>
            </div>

            <div class="layui-input-inline layui-select-sm">
                <select name="sqlTexts" id="sqlTexts" lay-filter="sqlTexts" lay-search="" lay-affix="clear"></select>
            </div>

            <button class="layui-btn layui-btn-primary layui-btn-sm layui-border-green"
                    id="execute" lay-submit lay-filter="execute">
                <i class="layui-icon layui-icon-play"></i> 执行F8
            </button>

            <button id="saveSqlText" class="layui-btn layui-btn-primary layui-btn-sm layui-border-orange"
                    lay-submit lay-filter="saveSqlText">
                <i class="layui-icon layui-icon-add-1"></i> 保存F9
            </button>

            <button id="codeFormat" class="layui-btn layui-btn-primary layui-btn-sm layui-border-blue"
                    lay-submit lay-filter="codeFormat">
                <i class="layui-icon layui-icon-fonts-clear"></i>
            </button>

            <button id="exportExcel" class="layui-btn layui-btn-primary layui-btn-sm layui-border-red"
                    lay-submit lay-filter="exportExcel">
                <i class="layui-icon layui-icon-export"></i>
            </button>


            <button id="showSqlDiv" class="layui-btn layui-btn-primary layui-btn-sm layui-border-purple"
                    lay-submit lay-filter="showSqlDiv">
                <i class="layui-icon layui-icon-up"></i>
            </button>

            <button class="layui-btn layui-btn-primary layui-btn-sm layui-border-blue"
                    id="setting-dropdown-demo-content">
                <i class="layui-icon layui-icon-set"></i>
            </button>

            <div lay-on="ai-offset-t"
                 style="cursor: pointer;display: inline-block;vertical-align: middle;height: 24px; width: 78px; border-radius: 12px; position: relative; background: url('data:image/png;base64,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') no-repeat center; background-size: cover;margin-left: 10px;"
                 title="AI智能助手">
                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 12px; text-shadow: 1px 1px 1px rgba(0,0,0,0.5);">AI</span>
            </div>

            <div id="rollBox"
                 style="margin-left:5px;height:40px;line-height:40px;text-align:center;overflow:hidden;">
            </div>
        </div>
    </form>
</div>

<div class="card sqlText" id="ID-dropdown-contextmenu">
    <textarea id='sqlText' style="width: 99%;height: 400px;align-content: center;"></textarea>
</div>

<div id="msgDiv" class="layui-row sqlTab card"
     style="display: none;position: relative;padding: 8px;box-sizing: border-box;">
    <div style="font-size: 13px;color: #61914e;display:block;">
        <span id="msgSpan"
              style="margin-left: 10px;display:block;width:95%;word-wrap:break-word;white-space:normal;"></span>
    </div>
    <i class="layui-icon layui-icon-close layui-unselect layui-tab-close" id="closeMsgDivBtn"></i>
</div>

<div class="layui-row sqlTab card" style="display: none;" id="sqlTableDiv">
    <div class="layui-tab layui-tab-brief" lay-filter="sqlTableTab" lay-allowclose="true">
        <ul class="layui-tab-title" id="lists">
        </ul>
        <div class="layui-tab-content" id="listsContent">
        </div>
    </div>
</div>
<div id="view-open-table-wrapper" style="display: none;padding: 10px;" class="hidden-scrollbar">
</div>
<script type="text/html" id="settingTable">
    <div class="layui-clear-space">
        <form class="layui-form layui-form-pane" action="">

            <div class="layui-form-item">
                <label class="layui-form-label">表格大小</label>
                <div class="layui-input-block">
                    <div class="layui-btn-group" style="margin-left: 5px;">
                        <button type="button" class="layui-btn layui-btn-primary layui-btn-sm"
                                onclick="viewStore.put('tableSize', 'lg');return false;">
                            <i class="layui-icon layui-icon-addition"></i>
                        </button>
                        <button type="button" class="layui-btn layui-btn-primary layui-btn-sm"
                                onclick="viewStore.put('tableSize', 'md');return false;">
                            <i class="layui-icon layui-icon-ok"></i>
                        </button>
                        <button type="button" class="layui-btn layui-btn-primary layui-btn-sm"
                                onclick="viewStore.put('tableSize', 'sm');return false;">
                            <i class="layui-icon layui-icon-subtraction"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">字体大小</label>
                <div class="layui-input-block">
                    <div class="layui-form-mid slider-wrapper">
                        <div id="id-slider" style="width: 130px;"></div>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">编辑器高度</label>
                <div class="layui-input-block">
                    <div class="layui-form-mid slider-wrapper">
                        <div id="id-editorSlider" style="width: 130px;"></div>
                    </div>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label">多窗口</label>
                <div class="layui-input-block">
                    <button id="newSqlOpen" onclick="window.open(ctx+'sqlManager/sqlPage');return false"
                            class="layui-btn layui-btn-primary layui-btn-sm" style="margin-left: 5px;">
                        <i class="layui-icon layui-icon-layer"></i> F7
                    </button>
                </div>
            </div>

        </form>
    </div>
</script>
<script th:src="@{/static/layui.js}"></script>
<script th:replace="~{base::ctx}"></script>
<script th:src="@{/static/lay-config.js}"></script>
<script th:src="@{/static/code/codemirror.js}"></script>
<script th:src="@{/static/code/matchbrackets.js}"></script>
<script th:src="@{/static/code/sql.js}"></script>
<script th:src="@{/static/code/show-hint.js}"></script>
<script th:src="@{/static/code/sql-hint.js}"></script>
<script th:src="@{/static/code/sql-formatter.min.cjs}"></script>
<script th:src="@{/static/code/placeholder.js}"></script>
<script th:src="@{/static/code/highlight.min.js}"></script>
<script th:src="@{/static/base64.min.js}"></script>
<script th:replace="~{tableSqlPageMeta}"></script>
<script>
    const textArr = [
        '【编辑器】区域内鼠标点击右键试试~',
        '【编辑器】选中表名+Alt+X 可以查看元数据~',
        '【编辑器】选中表名+Alt+Z 查看建表语句~',
        '【编辑器】Alt+C 格式化SQL',
        '【编辑器】Ctrl  可以自动提示关联',
        '【编辑器】F7    打开新的窗口',
        '【编辑器】F8    执行所有SQL语句',
        '【编辑器】F9    保存SQL片段',
        '【编辑器】选中内容+F8 选中SQL单条执行',
        '拖动左侧滑块，可以修改编辑大小哦~',
        '【结果集】 选中数据右键试试~',
        '全部导出为离线全量下载，小数据量推荐使用结果集右上角导出~',
        '无法执行Drop等语句？ 参数设置-语句限制修改~',
        '默认展示多少条数据能修改吗？ 默认1000条，参数设置-分页条数修改！'
    ];
    layui.use(['jquery', 'layer', 'form', 'element', 'laySelect', 'table', 'dropdown', 'util', 'laytpl', 'code', 'slider'], function () {
        const layer = layui.layer;
        const form = layui.form;
        const $ = layui.jquery;
        const element = layui.element;
        const select = layui.laySelect;
        const table = layui.table;
        const dropdown = layui.dropdown;
        const util = layui.util;
        const laytpl = layui.laytpl;
        const code = layui.code;
        const slider = layui.slider;
        let pageVisibility;  //页面隐藏
        let editorFontSizeKey = "editorFontSize";
        let tableSizeKey = "tableSize";
        let editorHeightKey = "editorHeight";
        let aiViewId = null;


        /**
         * 编辑器初始化
         * @type {CodeMirror}
         */
        const editor = CodeMirror.fromTextArea(document.getElementById("sqlText"), {
            mode: {
                name: "text/x-plsql"
            },
            matchBrackets: true,
            styleActiveLine: true,
            indentWithTabs: true,
            smartIndent: true,
            lineNumbers: true,
            spellcheck: true,
            lineWrapping: true,
            resetSelectionOnContextMenu: true,
            extraKeys: {
                'Ctrl': 'autocomplete',
                Tab: function (cm) {
                    let spaces = Array(cm.getOption('indentUnit') + 1).join(' ');
                    cm.replaceSelection(spaces);
                },
                'Alt-X': function (cm) {
                    hintMeta(cm);
                },
                'Alt-C': function (cm) {
                    formatSql(cm);
                },
                'Alt-Z': function (cm) {
                    showTableSql(cm);
                }
            },
            hintOptions: {completeSingle: false}
        });

        /**
         * 自动提示
         */
        editor.on('keypress', () => {
            editor.showHint();
        });

        /**
         * 字体.编辑器大小调整
         * @type {HTMLElement}
         */
        editor.getWrapperElement().style.fontSize = viewStore.get(editorFontSizeKey, 14) + 'px';
        editor.setSize(null, viewStore.get(editorHeightKey, 230));
        editor.refresh();

        /**
         * 展示数据源
         */
        let activeDataSource;//选中的数据源
        select.render({
            elem: "#dbtype",
            url: ctx + 'dataSourceManager/findDataSourceList',
            select: 10000,
            title: '请选择数据源',
            format: function (data) {
                return parseSelectData(data);
            },
            success: function (data, activeData) {
                //默认选中的数据源需要单独赋值，不会走onSelect
                activeDataSource = activeData == null ? null : activeData[0].code;
                editorHintSettings();
                if (activeDataSource) {
                    sqlTextSelect(activeDataSource);
                }
            },
            onselect: function (data) {
                activeDataSource = data;
                editorHintSettings();
                if(aiViewId != null){
                    layer.close(aiViewId);
                }
                sqlTextSelect(data);
            }
        });

        /**
         * 跑马灯提示
         * @type {string[]}
         */
        let box = $('#rollBox');
        let index = 0;
        box.html('<span class="roll-item layui-anim layui-anim-upbit">' + textArr[0] + '</span>');
        setInterval(function () {
            index = (index + 1) % textArr.length;
            box.find('.roll-item').addClass('layui-anim-upbit out');
            setTimeout(function () {
                box.html('<span class="roll-item layui-anim layui-anim-upbit ">' + textArr[index] + '</span>');
            }, 200);
        }, 3000);


        /**
         * 选中内容中获取表名
         * @param cm
         * @returns {*}
         */
        function getSelectTable(cm) {
            let table = cm.getSelection();
            if (table.length === 0 || activeDataSource === null || activeDataSource === '') {
                throw '请选中表名且选中数据源后，在使用快捷键~';
            }
            return table;
        }

        /**
         * 提示元数据
         */
        function hintMeta(cm) {
            if (activeDataSource === null || activeDataSource === '') {
                return false;
            }
            post(ctx + "sqlManager/findMetaTable?database=" + activeDataSource + "&table=" + getSelectTable(cm), null, (res) => {
                if (res.code != 200 || res.data === null) {
                    console.warn("无法提示元数据信息!" + res.msg);
                    return false;
                }
                laytpl($("#view-tale-meta-tpl").html()).render(res.data, function (data) {
                    $("#view-open-table-wrapper").html(data);
                    layer.open({
                        type: 1,
                        area: ['630px', '540px'],
                        title: false,
                        anim: 'slideUp',
                        closeBtn: 0,
                        shadeClose: true,
                        scrollbar: false,
                        content: $('#view-open-table-wrapper')
                    });
                });
            });
        }


        /**
         * 格式化SQL文本
         */
        function formatSql(cm) {
            let config = {
                "language": "sql",
                "tabWidth": 3,
                "keywordCase": "upper"
            };
            try{
                let newContent = window.sqlFormatter.format(cm.getValue(), config);
                cm.setValue(newContent);
            }catch (e){
                console.warn("无法格式化SQL文本!" + e.message);
            }
        }

        /**
         * 提示建表语句
         * @param cm
         * @returns {boolean}
         */
        function showTableSql(cm) {
            if (activeDataSource === null || activeDataSource === '') {
                return false;
            }
            post(ctx + "sqlManager/showTableSql?database=" + activeDataSource + "&table=" + getSelectTable(cm), null, (res) => {
                if (res.code != 200 || res.data === null) {
                    console.warn("无法展示建表语句信息!" + res.msg);
                    return false;
                }
                laytpl($("#table-sql-code-tpl").html()).render(res.data, function (data) {
                    $("#view-open-table-wrapper").html(data);
                    code({
                        elem: '.sql-code',
                        lang: 'SQL',
                        highlighter: "hljs",
                        encode: true,
                        langMarker: true,
                        codeRender: function (code, opts) {
                            return hljs.highlight(code, {language: opts.lang}).value;
                        }
                    });
                    layer.open({
                        type: 1,
                        area: ['630px', '540px'],
                        title: false,
                        anim: 'slideUp',
                        closeBtn: 0,
                        shadeClose: true,
                        scrollbar: false,
                        content: $('#view-open-table-wrapper'),
                    });
                });
            });
        }

        /**
         * 设置编辑器提示表名及字段功能
         */
        function editorHintSettings() {
            if (activeDataSource === null || activeDataSource === '') {
                return false;
            }
            post(ctx + "sqlManager/findTableField?database=" + activeDataSource, null, (res) => {
                if (res.code != 200 || res.data === null) {
                    console.warn("获取表名及字段失败,无法提供编辑器提示表名功能!" + res.msg);
                    return false;
                }
                editor.setOption('hintOptions', {
                    completeSingle: false,
                    tables: res.data
                });
            });
        }

        /**
         * 展示sql保存记录
         */
        function sqlTextSelect(dataSourceCode) {
            select.render({
                elem: "#sqlTexts",
                url: ctx + 'sqlManager/querySqlTextSelect?dataSourceCode=' + encodeURIComponent(dataSourceCode),
                select: 10000,
                title: 'SQL片段',
                format: function (data) {
                    return parseSelectData(data);
                },
                success: function (data, activeData) {
                },
                onselect: function (data) {
                    data = Base64.decode(data);
                    let oldContent = editor.getValue();
                    if (oldContent != null && oldContent.length > 0) {
                        data = oldContent + '\n' + data;
                    }
                    editor.setValue(data);
                }
            });
        }

        sqlTextSelect();

        /**
         * 保存SQL文本
         */
        form.on('submit(saveSqlText)', function (data) {
            if (activeDataSource === "" || activeDataSource == null) {
                message("请先选择数据源~", false);
                return false;
            }
            let sqlContent = editor.getValue().trim();
            if (sqlContent === "" || sqlContent == null) {
                message("请输入SQL语句后保存~", false);
                return false;
            }
            let openConfig = {
                type: 1,
                skin: 'layui-layer-win10',
                shade: 0.3,
                area: '520px',
                title: '*SQL片段',
                closeBtn: 0,
                formType: 0,
                anim: 'slideDown',
                shadeClose: true,
                success: function () {
                    $(".layui-layer-content .layui-layer-input").toggleClass("layui-input").attr('placeHolder', '请起个名字.');
                }
            };
            layer.prompt(openConfig, function (data, index) {
                if (data === '' || data == null) {
                    layer.msg('名字不能为空~', {icon: 2});
                    return false;
                }
                layer.close(index);
                // 获取当前选中的数据源信息
                let dataSourceInfo = null;
                if (activeDataSource) {
                    // 从数据源下拉框中获取数据源名称
                    const selectedOption = $('#dbtype option[value="' + activeDataSource + '"]');
                    if (selectedOption.length > 0) {
                        dataSourceInfo = {
                            code: activeDataSource,
                            name: selectedOption.text()
                        };
                    }
                }
                
                const params = {
                    'sqlText': Base64.encode(sqlContent), 
                    'title': data
                };
                
                // 如果有数据源信息，添加到参数中
                if (dataSourceInfo) {
                    params.dataSourceCode = dataSourceInfo.code;
                    params.dataSourceName = dataSourceInfo.name;
                }
                
                post(ctx + "sqlManager/saveSqlText", params, (res) => {
                    layer.msg(res.msg, {icon: res.code === 200 ? 1 : 2}, (res) => {
                        sqlTextSelect();
                    });
                })
            });
            return false;
        });


        /**
         * sql执行窗口隐藏
         */
        form.on('submit(showSqlDiv)', function (data) {
            let display = $('.sqlText').css('display');
            if (display === 'none') {
                $('.sqlText').css('display', 'block');
                $("#msgDiv").css('display', 'block');
                $("#showSqlDiv").html('<i class="layui-icon layui-icon-up">&nbsp;</i>');
            } else {
                $('.sqlText').css('display', 'none');
                $("#msgDiv").css('display', 'none');
                $("#showSqlDiv").html('<i class="layui-icon layui-icon-down">&nbsp;</i>');
            }
            return false;
        });


        /**
         * 隐藏信息内容
         */
        $("#closeMsgDivBtn").click(function () {
            $("#msgDiv").css('display', 'none');
        });

        /**
         * 执行SQL
         */
        form.on('submit(execute)', function (data) {
            $("#sqlTableDiv").hide();
            if (activeDataSource === "" || activeDataSource == null) {
                message("请先选择数据源~", false);
                return false;
            }
            let sqlContent = editor.getValue().trim();
            if (sqlContent === "" || sqlContent == null) {
                message("请输入要执行的SQL~", false);
                return false;
            }
            let pitchTxt = editor.getSelection();
            if (pitchTxt.length !== 0) {
                sqlContent = pitchTxt;
            }
            let intervalTime = 0;
            let interval = setInterval(function () {
                intervalTime++;
                message("执行耗时:" + intervalTime + "毫秒", true);
            }, 1);
            post(ctx + "sqlManager/executeSqlNew", {'dataBaseName': activeDataSource, 'sqlText': sqlContent}, (res) => {
                window.clearInterval(interval);
                if (pageVisibility === 'hidden') {
                    sendNotification("SQL执行完成,请查看页面执行结果~");
                }
                if (!res) {
                    message("结果返回未知异常！", false);
                    return false;
                }
                if (res.code !== 200) {
                    let msg = res.msg == null ? "空指针异常,请查看日志!" : res.msg;
                    message(msg, false);
                    return false;
                }
                setTimeout(() => tableInit(res.data), 0);
            });
            return false;
        });


        /**
         * 渲染数据表格
         * @param table
         * @param data
         * @returns {boolean}
         */
        let elementTabCount = [];//tab总数
        function tableInit(data) {
            for (let i = 0; i < elementTabCount.length; i++) {
                element.tabDelete('sqlTableTab', elementTabCount[i]);
            }
            $("#sqlTableDiv").hide();
            $("#msgDiv").hide();
            $("#msgSpan").html("");
            let index = 0;
            for (let i = 0; i < data.length; i++) {
                index++;
                let item = data[i];
                let statusMsg = "";
                if ((typeof item.data === 'number' && !isNaN(item.data))) {
                    statusMsg = item.status === 2 ? "执行失败 " + item.errorMessage : "执行成功影响【" + item.data + "】条数据!";
                }
                if (item.data === null) {
                    statusMsg = item.status === 2 ? "执行失败 " + item.errorMessage : "执行成功返回为空!";
                }
                if (item.data instanceof Array && item.status === 2) {
                    statusMsg = "执行失败 " + item.errorMessage;
                }
                if (typeof item.data == 'string' && item.status === 2) {
                    statusMsg = "执行失败 " + item.errorMessage;
                }
                if (statusMsg !== "") {
                    let msg = "第[" + index + "]条SQL语句" + statusMsg + "<br>";
                    $("#msgSpan").append(msg);
                    $("#msgDiv").show();
                }
                if (item.type === 1) {
                    continue;
                }
                if (item.status === 2) {
                    continue;
                }
                //渲染表格
                $("#sqlTableDiv").show();
                let rowsData = item.data;
                let headArr = Object.keys(rowsData[0]);
                let head = [];
                for (let key in headArr) {
                    head.push({field: headArr[key], title: headArr[key], sort: true});
                }
                if (rowsData.length === 1) {
                    let distinctList = [...new Set(Object.values(data[i].data[0]))];
                    if (distinctList.length === 1 && distinctList[0] === "WEB_SQL_PLACEHOLDER") {
                        rowsData = [];
                    }
                }
                //add Tab
                let elId = "sqlTable" + index;
                elementTabCount.push(elId);
                element.tabAdd('sqlTableTab', {
                    title: '结果集' + index,
                    content: "<table class='layui-table' id='" + elId + "'></table>",
                    id: elId,
                    change: true
                })
                table.render({
                    elem: '#' + elId
                    , cols: [head]
                    , data: rowsData
                    , time: item.time
                    , title: '结果集' + (i + 1)
                    , loading: true
                    , height: 535
                    , cellMinWidth: 150
                    , limit: 50
                    , limits: [50, 500, 1000, 3000, 5000, 8000, 10000]
                    , even: true
                    , toolbar: '#table-page-toolbar'
                    , defaultToolbar: ['filter', 'exports', 'print']
                    , page: {prev: '上一页', next: '下一页', groups: 6}
                    , defaultContextmenu: false
                    , pagebar: '#table-page-pageBar'
                    , text: {none: '查询返回0条数据'}
                    , size: viewStore.get(tableSizeKey, 'sm')
                });
                table.resize(elId);
                rowContextMenu(elId, item);
                pageBar(elId);
            }
            return false;
        }


        /**
         * 发起导出申请，查询结果的数据导出excel
         */
        form.on('submit(exportExcel)', function (data) {
            if (activeDataSource === "" || activeDataSource == null) {
                message("您修改数据源后请重新查询~", false);
                return false;
            }
            let sqlContent = editor.getValue().trim();
            if (sqlContent === "" || sqlContent == null) {
                message("请输入SQL语句后在导出~", false);
                return false;
            }
            let pitchTxt = editor.getSelection();
            if (pitchTxt.length !== 0) {
                sqlContent = pitchTxt;
            }
            post(ctx + "sqlManager/createAsyncExport", {
                'dataBaseName': activeDataSource,
                'sqlText': sqlContent
            }, (res) => {
                if (!res) {
                    layer.msg("导出失败.", {icon: 2});
                    return false;
                }
                if (res.code !== 200) {
                    layer.msg(res.msg, {icon: 2, time: 5000});
                    return false;
                }
                var async = res.data.async;
                var id = res.data.id;
                if (!async) {
                    if (pageVisibility === 'hidden') {
                        sendNotification("文件导出中,请查看浏览器下载记录~");
                    }
                    window.open(ctx + "sqlManager/downloadExcelFile?id=" + id);
                } else {
                    layer.msg("生成文件中请不要关闭页面,结束会自动下载!", {icon: 1, time: 3000}, () => {
                        downloadExcel(id);
                    });
                }
            });
            return false;
        });

        /**
         * 异步导出文件，轮询检查是否完成
         * @param id
         */
        function downloadExcel(id) {
            var finalId = id;
            post(ctx + "sqlManager/queryExportData?id=" + id, null, (res) => {
                if (!res) {
                    layer.msg("导出失败.", {icon: 2});
                    return false;
                }
                if (res.code === 500 && res.msg === "导出中") {
                    console.info("别着急,还在生产excel..." + finalId);
                    setTimeout(() => downloadExcel(finalId), 3000);
                    return false;
                }
                if (res.code !== 200) {
                    layer.msg(res.msg, {icon: 2});
                    return false;
                }
                var id = res.data.id;
                if (pageVisibility === 'hidden') {
                    sendNotification("文件导出中,请查看浏览器下载记录~");
                }
                window.open(ctx + "sqlManager/downloadExcelFile?id=" + id);
            });
        }

        /**
         * 分页btn 增加返回顶部
         */
        function pageBar(id) {
            table.on('pagebar(' + id + ')', function (obj) {
                let eventValue = obj.event;
                if (eventValue === "footerBtn1") {
                    window.scrollTo({
                        top: 0,
                        behavior: "smooth"
                    });
                    return false;
                }
                if (eventValue === "footerBtn2") {
                    window.scrollTo({
                        top: 70,
                        behavior: "smooth"
                    });
                    return false;
                }
            });
        }

        /**
         * 表格增加点击事件
         */
        function rowContextMenu(id, res) {
            table.on('rowContextmenu(' + id + ')', function (obj) {
                let data = obj.data;
                let index = obj.index;
                let tableName = '';
                try {
                    let tableList = JSON.parse(res.tableNameList);
                    tableName = tableList[0];
                } catch (e) {
                    tableName = res.tableNameList;
                }
                let columns = Object.keys(data);
                let dropdownInstance = dropdown.render({
                    trigger: 'contextmenu',
                    show: true,
                    data: [
                        {title: 'copy insert', id: 'insert'},
                        {title: 'copy update', id: 'update'},
                        {title: 'copy select', id: 'select'},
                        {title: 'copy json', id: 'json'},
                        {title: 'copy 字段名', id: 'head'},
                        {title: 'copy 字段值', id: 'value'}
                    ],
                    click: function (menuData, othis) {
                        if (menuData.id === "json") {
                            copyToClipboard(JSON.stringify(data, null, 2));
                            layer.msg('JSON数据已复制到剪贴板');
                            return true;
                        }
                        if (menuData.id === "head") {
                            let columns = Object.keys(data);
                            copyToClipboard(columns.join(','));
                            layer.msg('字段名已复制到剪贴板');
                            return true;
                        }
                        if (menuData.id === "value") {
                            let columns = Object.keys(data);
                            let values = columns.map(col => {
                                let val = data[col];
                                if (val === null) return '';
                                return String(val);
                            });
                            copyToClipboard(values.join(','));
                            layer.msg('字段值已复制到剪贴板');
                            return true;
                        }
                        if (menuData.id === "insert") {
                            let values = columns.map(col => {
                                let val = data[col];
                                if (val === null) return 'NULL';
                                if (typeof val === 'string') return `'${val.replace(/'/g, "''")}'`;
                                if (typeof val === 'number') return val;
                                if (val instanceof Date) return `'${val.toISOString().slice(0, 19).replace('T', ' ')}'`;
                                return `'${val}'`;
                            });
                            let insertSql = `INSERT INTO ${tableName} (${columns.join(', ')})
                                             VALUES (${values.join(', ')});`;
                            copyToClipboard(insertSql);
                            layer.msg('INSERT语句已复制到剪贴板');
                            return true;
                        }
                        if (menuData.id === "update") {
                            let setParts = columns.map(col => {
                                let val = data[col];
                                if (val === null) return `${col} = NULL`;
                                if (typeof val === 'string') return `${col} = '${val.replace(/'/g, "''")}'`;
                                if (typeof val === 'number') return `${col} = ${val}`;
                                if (val instanceof Date) return `${col} = '${val.toISOString().slice(0, 19).replace('T', ' ')}'`;
                                return `${col} = '${val}'`;
                            });
                            let firstCol = columns[0];
                            let firstVal = data[firstCol];
                            let whereClause = typeof firstVal === 'string'
                                ? `${firstCol} = '${firstVal.replace(/'/g, "''")}'`
                                : `${firstCol} = ${firstVal}`;
                            let updateSql = `UPDATE ${tableName}
                                             SET ${setParts.join(', ')}
                                             WHERE ${whereClause};`;
                            copyToClipboard(updateSql);
                            layer.msg('UPDATE语句已复制到剪贴板');
                            return true;
                        }
                        if (menuData.id === "select") {
                            let firstCol = columns[0];
                            let firstVal = data[firstCol];
                            let whereClause = typeof firstVal === 'string'
                                ? `${firstCol} = '${firstVal.replace(/'/g, "''")}'`
                                : `${firstCol} = ${firstVal}`;
                            let selectSql = `SELECT ${columns.join(', ')}
                                             FROM ${tableName}
                                             WHERE ${whereClause};`;
                            copyToClipboard(selectSql);
                            layer.msg('SELECT语句已复制到剪贴板');
                            return true;
                        }
                    }
                });
            });
        }

        // 辅助函数：复制文本到剪贴板
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        function message(text, flag) {
            $("#msgDiv").show();
            if (!flag) {
                $("#msgSpan").text(text);
                $("#sqlTableDiv").hide();
            } else {
                $("#msgSpan").text(text);
                $("#sqlTableDiv").show();
            }
        }

        /**
         * tab删除事件,最后一个被删除是隐藏tableDiv
         */
        element.on('tabDelete(sqlTableTab)', function (data) {
            try {
                if ($("#lists li").length == 0) {
                    $("#sqlTableDiv").hide();
                }
            } catch (err) {
                console.error('隐藏失败');
            }
        });

        /**
         * tab切换事件,修正table表格单元格不对齐问题
         */
        element.on('tab(sqlTableTab)', function (data) {
            try {
                table.resize("sqlTable" + data.index);
            } catch (err) {
                console.error('resize 失败');
            }
        });

        /**
         * 动态悬浮功能菜单
         */
        document.addEventListener('scroll', function () {
            var navContainer = document.getElementById("menu-id");
            if (window.pageYOffset > 0) {
                navContainer.classList.add('nav-container', 'show');
            } else {
                navContainer.classList.remove('nav-container', 'show');
            }
        });

        /**
         * 快捷键
         * @param event
         */
        document.onkeydown = function (event) {
            var e = event || window.event || arguments.callee.caller.arguments[0];
            if (e && e.keyCode == 119) {
                $("#execute").trigger('click');
            }
            if (e && e.keyCode == 118) {
                $("#newSqlOpen").trigger('click');
            }
            if (e && e.keyCode == 120) {
                $("#saveSqlText").trigger('click');
            }
        };

        /**
         * 检查页面是否隐藏
         */
        document.addEventListener('visibilitychange', function () {
            pageVisibility = document.visibilityState
        })

        // 初始化设置组件
        const settingView = function () {
            slider.render({
                elem: '#id-slider',
                value: viewStore.get(editorFontSizeKey, 14),
                min: 10,
                max: 30,
                change: function (size) {
                    editor.getWrapperElement().style.fontSize = size + 'px';
                    editor.refresh();
                },
                done: function (value) {
                    viewStore.put(editorFontSizeKey, value);
                }
            });
            slider.render({
                elem: '#id-editorSlider',
                value: viewStore.get(editorHeightKey, 230),
                min: 100,
                max: 800,
                theme: '#22aaff',
                change: function (size) {
                    editor.setSize(null, size);
                },
                done: function (value) {
                    if (value) {
                        viewStore.put(editorHeightKey, value);
                    }
                }
            });
        };
        settingView();

        /**
         *  设置菜单
         */
        dropdown.render({
            elem: '#setting-dropdown-demo-content',
            content: [$("#settingTable").html()].join(''),
            className: 'setting-dropdown-tabs',
            style: 'width: 300px; height: 180px; box-shadow: 1px 1px 30px rgb(0 0 0 / 12%);border-radius:10px;padding:10px;',
            //shade: 0.3,
            ready: function () {
                settingView();
            }
        });


        // 右键菜单
        dropdown.render({
            elem: '#ID-dropdown-contextmenu',
            trigger: 'contextmenu',
            isAllowSpread: false,
            //style: 'width: 200px',
            accordion: true,
            data: [
                {
                    title: '执行',
                    id: 'execute'
                },
                {
                    title: '格式化',
                    id: 'format'
                },
                {
                    title: '清空',
                    id: 'clear'
                },
                {
                    title: '保存',
                    id: 'save'
                },
                {
                    title: '导出',
                    id: 'export'
                }, {
                    title: '刷新',
                    id: 'reload'
                }, {type: '-'}, {
                    title: '更多',
                    id: '#3',
                    child: [{
                        title: '元数据',
                        id: 'meta'
                    }, {
                        title: '建表语句',
                        id: 'createSql'
                    }, {
                        title: '新窗口',
                        id: 'open'
                    }]
                },
            ],
            click: function (obj, othis) {
                if (obj.id === 'execute') {
                    $("#execute").trigger('click');
                }
                if (obj.id === 'open') {
                    $("#newSqlOpen").trigger('click');
                }
                if (obj.id === 'save') {
                    $("#saveSqlText").trigger('click');
                }
                if (obj.id === 'export') {
                    $("#exportExcel").trigger('click');
                }
                if (obj.id === 'reload') {
                    location.reload();
                }
                if(obj.id ==='clear'){
                    editor.setValue('');
                }
                //格式化
                if (obj.id === 'format') {
                    const altCKeyHandler = editor.getOption("extraKeys")["Alt-C"];
                    if (altCKeyHandler) {
                        altCKeyHandler(editor);
                    }
                }
                if (obj.id === 'format') {
                    const altCKeyHandler = editor.getOption("extraKeys")["Alt-C"];
                    if (altCKeyHandler) {
                        altCKeyHandler(editor);
                    }
                }
                if (obj.id === 'meta') {
                    const altCKeyHandler = editor.getOption("extraKeys")["Alt-X"];
                    if (altCKeyHandler) {
                        altCKeyHandler(editor);
                    }
                }
                if (obj.id === 'createSql') {
                    const altCKeyHandler = editor.getOption("extraKeys")["Alt-Z"];
                    if (altCKeyHandler) {
                        altCKeyHandler(editor);
                    }
                }
            }
        });

        //格式化文本
        form.on('submit(codeFormat)', function (data) {
            const altCKeyHandler = editor.getOption("extraKeys")["Alt-C"];
            if (altCKeyHandler) {
                altCKeyHandler(editor);
            }
            return false;
        });

        util.on('lay-on', {
            'ai-offset-t': function () {
                if (activeDataSource === null || activeDataSource === '') {
                    layer.msg('请选择数据源', {icon: 2});
                    return false;
                }
                let table = editor.getSelection() === undefined ? '' : editor.getSelection();
                const url = ctx + 'aiManager/page?database=' + activeDataSource + "&table=" + table;
                aiViewId = layer.open({
                    type: 2,
                    offset: 'r',
                    anim: 'slideLeft',
                    area: ['420px', '100%'],
                    shade: 0.1,
                    shadeClose: true,
                    title: 'AI Data Copilot',
                    hideOnClose: true,
                    id: 'ai-layer-direction-r',
                    content: [url, 'yes']
                });
            }
        });


        //AI结果执行
        window.addEventListener('message', function(event) {
            if (event.data.type === 'executeSQL') {
                var sqlFromAI = event.data.sql;
                editor.setValue(sqlFromAI);
                $("#execute").trigger('click');
            }
        });


        //进入页面后,让编辑器获得焦点
        editor.focus();
    })

</script>
</body>
</html>